<html>
  <head>
    <!-- Bootstrap core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- Jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
    <title>webRTC Testing</title>
  </head>
  <body>
  <p>Relay Server is running...</p>	  
  <script>
      //initialize variables
      var global_username = '';
      var global_channel = 'room123';
      var global_usernames = new Array();
      var global_users = new Array();
      var idx = '';
      var global_temp_users = '';
      var websocket = null;
      var socket_host = 'https://dune1989.github.io/relayserver/';
      var socket_port = '9996';
      var wsretry = null;
      var user = global_username;
      var users = [];
      var websocket_worker = null;
      
      //create a new WebSocket object.
      var wsUri = "wss://connect.websocket.in/rtctrial?room_id=generalroom"; 	
      websocket = null;

      websocket = new WebSocket(wsUri);
      
      websocket.on('connection', function(connection) {
  
      console.log("User connected");
	
      //when server gets a message from a connected user 
      connection.on('message', function(message) { 
          var data;
          //accepting only JSON messages 
          try { 
             data = JSON.parse(message); 
          } catch (e) { 
             console.log("Invalid JSON"); 
             data = {}; 
          }
		
          //switching type of the user message 
          switch (data.type) { 
             //when a user tries to login 
             case "login": 
                console.log("User logged", data.name); 

                //if anyone is logged in with this username then refuse 
                if(users[data.name]) { 
	           var arr = { type: "login", success: false };
                } else { 
                   //save user connection on the server 
                   users[data.name] = connection; 
                   connection.name = data.name;
		   var arr = { type: "login", success: true };		
                } 
		websocket.send(JSON.stringify(arr)); 
                break;

             case "offer": 
                //for ex. UserA wants to call UserB 
                console.log("Sending offer to: ", data.name); 

                //if UserB exists then send him offer details 
                var conn = users[data.name]; 

                if(conn != null) { 
                   //setting that UserA connected with UserB 
                   connection.otherName = data.name; 
		   var arr = { type: "offer", offer: data.offer, name: connection.name };
		   websocket.send(JSON.stringify(arr));	
                } 
                break;

             case "answer": 
                console.log("Sending answer to: ", data.name); 
                //for ex. UserB answers UserA 
                var conn = users[data.name]; 

                if(conn != null) { 
                   connection.otherName = data.name; 
		   var arr = { type: "answer", answer: data.answer };		
	           websocket.send(JSON.stringify(arr));		
                } 

                break;

             case "candidate": 
                console.log("Sending candidate to:",data.name); 
                var conn = users[data.name];  

                if(conn != null) { 
		   var arr = { type: "candidate", candidate: data.candidate };		
	           websocket.send(JSON.stringify(arr));		
                } 

                break;

             case "leave": 
                console.log("Disconnecting from", data.name); 
                var conn = users[data.name]; 
                conn.otherName = null; 

                //notify the other user so he can disconnect his peer connection 
                if(conn != null) { 
	           var arr = { type: "leave" };		
	           websocket.send(JSON.stringify(arr));		
                }  

                break;

             default:
		var arr = { type: "error", message: "Command not found: " + data.type };		
	        websocket.send(JSON.stringify(arr));

                break; 
          }  
      });
	
       //when user exits, for example closes a browser window 
       //this may help if we are still in "offer","answer" or "candidate" state 
       connection.on("close", function() { 

          if(connection.name) { 
             delete users[connection.name]; 

             if(connection.otherName) { 
                console.log("Disconnecting from ", connection.otherName); 
                var conn = users[connection.otherName]; 
                conn.otherName = null;  

                if(conn != null) { 
	           var arr = { type: "leave" };		
	           websocket.send(JSON.stringify(arr));	 
                }  
             } 
          } 
       });  
	
        connection.send("Hello world"); 
      }); 
 
      function sendTo(connection, message) { 
         connection.send(JSON.stringify(message)); 
      }
  </script>
  </body>
</html>
