<html>
  <head>
    <!-- Bootstrap core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- Jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
    <title>webRTC Testing</title>
  </head>
  <body>
  <p>Relay Server is running...</p>	  
  <script>
      //initialize variables
      var global_username = '';
      var global_channel = 'room123';
      var global_usernames = new Array();
      var global_users = new Array();
      var idx = '';
      var global_temp_users = '';
      var websocket = null;
      var socket_host = 'https://dune1989.github.io/relayserver/';
      var socket_port = '9996';
      var wsretry = null;
      var user = global_username;
      var users = [];
      var websocket_worker = null;
      
      $(document).ready(function(){	  
	  //create a new WebSocket object.
	  var wsUri = "wss://connect.websocket.in/rtctrial?room_id=generalroom"; 	
	  websocket = null;

	  websocket = new WebSocket(wsUri);
		
	  // connection is open
	  websocket.onopen = function(ev) { 
	      register_zone();
	      setTimeout("send_indentity();", 100);    
	      $("#terminal").html("<div>Room Connected</div>");             
	  }
	      
	  // send and received communication
	  websocket.onmessage = function(ev) {
              try {
		  //PHP sends Json data
	          var msg = JSON.parse(message.data);
	          //console.log(JSON.stringify(msg));
	          var obj;
                  if (typeof msg.data!="undefined") {
		      console.log(msg);	  
	          } else if (msg.disconnect!=undefined) {
                      obj = msg.disconnect;   
                      var msguserid = obj.user;
                      remove_user_element(msguserid)
                      //self.postMessage({"action":"onmessage", "data":{"type":"disconnect","obj":obj}});            
                      setTimeout("send_indentity();", 500);
                  }
                  
                      msg = null;		  
	      } catch (err0) { 
		 console.log("websocket.onmessage 0 - " + err0); 
	      }      
	 };
	      
	 websocket.onerror = function(ev){
	     console.log("websocket error"+ev)
	 }; 
	      
	 websocket.onclose = function(ev){ 
             console.log("websocket close"+ev)
	 }; 
	 
	 clearInterval(checker);
	 checker = setInterval(function(){
	    try {
	       send_indentity();  
	       //console.log("send_indentity ")
	    } catch(err) {console.log("send_indentity "+err.message)}
	 }, 5000);     
      });
	  
      function remove_user_element(userid) {
	   try { 
	       pc[userid].close() 
	       pc[userid] = null;
	       $("#user_list_dtl_"+userid).remove();        
	       $("#video"+userid).remove();
	       $("#videobox"+userid).remove();
	       offerecv[userid] = null;
	       negotiating[userid] = null;
	       mediaStreamSource[userid] = null;
	       audprocessor[userid] = null;
	       audioContext[userid] = null;
	   } catch(err) {}
      }	  
 
      function register_zone() {        
	    var msg = {"command":{"identify":global_username, "zone":global_channel}};
	    if(websocket!=null) {
		websocket.send(JSON.stringify(msg));
	    }
      }

      function send_indentity() {        
	    var msg = {"checkin":{"username":global_username, "user":global_username}};
	    send_data(msg, '');
      }
  </script>
  </body>
</html>
